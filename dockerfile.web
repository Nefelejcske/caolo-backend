FROM python:latest

ENV PATH /root/.cargo/bin:$PATH

EXPOSE 5000

# install rust
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs > install_rust.sh
RUN sh ./install_rust.sh -y
RUN rm ./install_rust.sh
RUN cargo --version

WORKDIR /web/webservice
COPY ./webservice/requirements.txt ./requirements.txt
RUN pip install -r requirements.txt

WORKDIR /web

# TODO these are needed for the workspace
# get rid of them
COPY ./simulation/ ./simulation/
COPY ./worker/ ./worker/

COPY ./Cargo.toml ./Cargo.toml
COPY ./Cargo.lock ./Cargo.lock
COPY ./rust-toolchain ./rust-toolchain

COPY ./api/ ./api/
COPY ./cao-lang/ ./cao-lang/
COPY ./webservice/ ./webservice/

WORKDIR /web/webservice
RUN pip install -r requirements.txt
RUN mkdir build
RUN maturin build --release -o ./build/
RUN ls -al build
RUN pip --version
RUN pip install build/caolo_web-0.1.0-cp38-cp38-manylinux1_x86_64.whl

ENTRYPOINT ["python", "main.py"]
