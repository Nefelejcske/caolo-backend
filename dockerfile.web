FROM python:3.8 AS build

ENV PATH /root/.cargo/bin:$PATH

# install rust
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs > install_rust.sh
RUN sh ./install_rust.sh -y
RUN cargo --version

WORKDIR /web

COPY ./webservice/requirements.txt ./requirements.txt
RUN pip install -r requirements.txt

# TODO these are needed for the workspace
# get rid of them
COPY ./simulation/ ./simulation/
COPY ./worker/ ./worker/

COPY ./Cargo.toml ./Cargo.toml
COPY ./Cargo.lock ./Cargo.lock
COPY ./rust-toolchain ./rust-toolchain

COPY ./api/ ./api/
COPY ./cao-lang/ ./cao-lang/
COPY ./webservice/ ./webservice/

WORKDIR /web/webservice
RUN pip install maturin
RUN mkdir build
RUN maturin build --release -o ./build/
RUN ls -al build

# --------------

FROM python:3.8-slim
RUN apt-get update
RUN apt-get install build-essential -y

WORKDIR /web
COPY --from=build /web/webservice/build/ ./build/
RUN pip install build/caolo_web-0.1.0-cp38-cp38-manylinux1_x86_64.whl
COPY ./webservice/requirements.txt ./requirements.txt
RUN pip install -r requirements.txt

# Copy the non-packaged scripts
COPY ./webservice/*.py ./
COPY ./webservice/migrations/ ./migrations
COPY ./webservice/caolo_web/ ./caolo_web
